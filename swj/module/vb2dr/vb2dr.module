<?php define(MAX_USER_PER_RUN, 1000);function vb2dr_menu() {  $items ['admin/settings/vb2dr'] = array(	'title' => t('vBulletin 2 Drupal'),	'description' => t('Set vBulletin db details into drupal\'s <i>settings.php</i> and run through update button or by clicking ').l('here', 'vb2dr'),	'access arguments' => array('administer users'),	'page callback' => 'vb2dr_check',	'type' => MENU_NORMAL_ITEM,		);   $items['admin/settings/vb2dr/del-user'] = array(		'title' => 'delete users',		'access arguments' => array('administer nodes'),		'page callback' => 'myfn_delete_users',		'type' => MENU_NORMAL_ITEM,		);  return $items;}function vb2dr_check() {  return drupal_get_form('vb2dr_migrate');}function vb2dr_migrate() {    $form = array();	$form['update'] = array(			'#type' => 'submit',			'#value' => t("Update"),			'#submit' => array('vb2dr_migrate_save'),			'#weight' => 0,			);	return $form;}function vb2dr_migrate_save($form, &$form_state) {  $vars = unserialize(variable_get('vb2dr'));  return vb2dr_migrate_users($vars['last_user']);}function vb2dr_migrate_users($last_user) {    $sql = "SELECT user.userid as id, user.usergroupid as gid, user.username as uname, user.password as pass, user.email as email, user.homepage as url, user.icq, user.aim, user.yahoo, user.msn, user.skype FROM {user} user WHERE user.userid >%d LIMIT 0, %d";  $vb_roles = array(2, 5, 6, 10, 27);  $found = 0;  $new = 0;  /* USERGROUPS and USERGROUP IDs       GROUP NAME 				GROUP ID	DRUPAL ROLE	  	  Administrators				6			7, 3	  Registered Users - New		2			7	  Registered Users - OK			27			7	  Super Moderators				5			4	  SWJ Bloggers					10			6  */    db_set_active('vb');  $result = db_query($sql, $last_user, MAX_USER_PER_RUN);  db_set_active('default');  while($row = db_fetch_object($result)) {    //var_dump(in_array($row->gid, $vb_roles));exit;    $user = user_load(array('name'=>$row->uname));	if ($user->uid) {		$found++;		drupal_set_message("User ".$row->name." found on record with uid: ".$user->uid);		continue;	}	else if(in_array($row->gid, $vb_roles)) { //Basic User Creation		$new++;		$user = array();		$user['name'] = $row->uname;		$user['pass'] = $row->pass;		$user['mail'] = $row->email;		$user['init'] = $row->email;		$user['status'] = 1;				user_save(NULL, $user);//Save user data				$profile = array();		$profile['user_website'] = $row->url;		$profile['user_icq'] = $row->icq;		$profile['user_aim'] = $row->aim;		$profile['user_yim'] = $row->yahoo;		$profile['user_msn'] = $row->msn;		$profile['user_skype'] = $row->skype;				$user_obj = user_load(array('name'=>$row->uname)); //Loading User Object		$profile['roles'] = $user_obj->roles;				//Adding Roles		switch($row->gid) {			case 2:			case 27:			  $profile['roles'][7] = 'Registered User';					break;			case 5:			  $profile['roles'][4] = 'Moderator';					break;			case 6:			  $profile['roles'][3] = 'Administrator';			  $profile['roles'][7] = 'Registered User';					break;			case 10:			  $profile['roles'][6] = 'Blog Author';					break;		}		user_save($user_obj, $profile);		drupal_set_message("User ".$row->uname." created with uid: ".$user_obj->uid);	}	vb2dr_save_settings($row->id);  }  $msg = $found." User found already in DB and ".$new." users created";  drupal_set_message($msg);  return $msg;}function vb2dr_save_settings($user) {  $vars['last_user'] = $user;  $vars['updated'] = time();  $variable = serialize($vars);    return variable_set('vb2dr', $variable);}function myfn_delete_users() {  global $user;  $result = db_query("SELECT uid FROM users");  $edit = array();  $data = NULL;  $i=1;  while ($row = db_fetch_object($result)) {    if ($row->uid != $user->uid && $row->uid != 1 && $row->uid != 0) {	  user_delete($edit, $row->uid);	  $data = $i."User: ".$row->uid;          $i++;	}  }  return $data;}